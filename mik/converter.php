<?php
/**
 *
 * @author Mikhail Kyosev (mialygk@gmail.com)
 * @license BSD
 */

/**
 * Convert Bulgarian MIK code page to UTF-8
 *
 * @param string $text MIK encoded Input string
 * @return string UTF-8 encoded string
 */
function MIKtoUTF8($text)
{
	$len = strlen($text);
	$out = '';

	$matrix = array(
		0xC0 => 0x2514, 0xC1 => 0x2534, 0xC2 => 0x252C, 0xC3 => 0x251C,
		0xC4 => 0x2500, 0xC5 => 0x253C, 0xC6 => 0x2563, 0xC7 => 0x2551,
		0xC8 => 0x255A, 0xC9 => 0x2554, 0xCA => 0x2569, 0xCB => 0x2566,
		0xCC => 0x2560, 0xCD => 0x2550, 0xCE => 0x256C, 0xCF => 0x2510,
		0xD0 => 0x2591, 0xD1 => 0x2592, 0xD2 => 0x2593, 0xD3 => 0x2502,
		0xD4 => 0x2524, 0xD5 => 0x2116, 0xD6 => 0x00A7, 0xD7 => 0x2557,
		0xD8 => 0x255D, 0xD9 => 0x2518, 0xDA => 0x250C, 0xDB => 0x2588,
		0xDC => 0x2584, 0xDD => 0x258C, 0xDE => 0x2590, 0xDF => 0x2580,
		0xE0 => 0x03B1, 0xE1 => 0x03B2, 0xE2 => 0x0393, 0xE3 => 0x03C0,
		0xE4 => 0x03A3, 0xE5 => 0x03C3, 0xE6 => 0x03BC, 0xE7 => 0x03B4,
		0xE8 => 0x03A6, 0xE9 => 0x0398, 0xEA => 0x03A9, 0xEB => 0x03B4,
		0xEC => 0x221E, 0xED => 0x03C6, 0xEE => 0x03B5, 0xEF => 0x2229,
		0xF0 => 0x2261, 0xF1 => 0x00B1, 0xF2 => 0x2265, 0xF3 => 0x2264,
		0xF4 => 0x2320, 0xF5 => 0x2321, 0xF6 => 0x00F7, 0xF7 => 0x2248,
		0xF8 => 0x00B0, 0xF9 => 0x2219, 0xFA => 0x00B7, 0xFB => 0x221A,
		0xFC => 0x207F, 0xFD => 0x00B2, 0xFE => 0x25A0, 0xFF => 0x00A0
	);

	for ($x = 0; $x < $len; $x++) {
		$ch = ord($text[$x]);
		if ($ch <= 0x7F) {
			// ASCII 0-127
			$out .= $text[$x];
		} else if ($ch >= 0x80 && $ch <= 0xBF) {
			// Cyrillic Capital A-Z to Cyrillic Small a-z
			$out .= '&#x'.dechex($ch + 0x390).';';
		} else if (isset($matrix[$ch])) {
			// all others...
			$out .= '&#x'.dechex($matrix[$ch]).';';
		}
	}
	return html_entity_decode($out, ENT_NOQUOTES, 'UTF-8');
}


/*******************************************************************************
 * test script
 ******************************************************************************/

// $filename = 'mik.txt';
$filename = 'hello.txt';

header("Content-type: text/plain; charset=utf-8");
if (($file = fopen($filename, "r")) === false) {
	exit('Error open file');
}

while (($line = fgets($file, 4096)) !== false) {
	echo MIKtoUTF8($line);
}
fclose($file);
